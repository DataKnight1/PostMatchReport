"""
Report Generator
Main module for generating complete match reports using ETL and Visual components.
"""

import matplotlib.pyplot as plt
import pandas as pd
from typing import Dict, Any, Optional, Tuple
import os

from ETL.loaders.data_loader import DataLoader
from ETL.transformers.match_processor import MatchProcessor
from Visual.pitch_visualizations import PitchVisualizations
from Visual.statistical_visualizations import StatisticalVisualizations
from Visual.heatmap_visualizations import HeatmapVisualizations
from Visual.advanced_visualizations import AdvancedVisualizations
from Visual.tactical_visualizations import TacticalVisualizer


class ReportGenerator:
    """Generate comprehensive match reports."""

    def __init__(self, cache_dir: str = "./cache", theme: str = 'dark'):
        """
        Initialize report generator.

        Args:
            cache_dir: Directory for caching data
            theme: 'dark' or 'light'
        """
        self.cache_dir = cache_dir
        self.data_loader = DataLoader(cache_dir)

        # Initialize visualization modules
        self.theme = theme.lower()
        if self.theme == 'dark':
            # Dark grey palette
            self.bg_color = '#22272e'
            self.text_color = '#e6edf3'
            pitch_color = '#2b313a'
            line_color = '#d0d7de'
        else:
            self.bg_color = '#f0f0f0'
            self.text_color = 'black'
            pitch_color = '#d6c39f'
            line_color = '#0e1117'

        self.pitch_viz = PitchVisualizations(pitch_color=pitch_color, line_color=line_color)
        self.stats_viz = StatisticalVisualizations()
        self.heatmap_viz = HeatmapVisualizations(pitch_color=pitch_color, line_color=line_color)
        self.advanced_viz = AdvancedVisualizations(pitch_color=pitch_color, line_color=line_color)
        self.tactical_viz = TacticalVisualizer()

    def _find_team_logo(self, team_id: Optional[int], team_name: Optional[str]) -> Optional[str]:
        """Try to resolve a team logo path locally under config/logos.

        Checks by ID then by sanitized name. Returns path or None.
        """
        base = os.path.join(os.path.dirname(__file__), '..', 'config', 'logos')
        base = os.path.abspath(base)
        candidates = []
        if team_id is not None:
            candidates.append(os.path.join(base, f"{team_id}.png"))
            candidates.append(os.path.join(base, f"{team_id}.jpg"))
            candidates.append(os.path.join(base, f"{team_id}.svg"))
        if team_name:
            key = ''.join(ch for ch in team_name.lower() if ch.isalnum())
            candidates.append(os.path.join(base, f"{key}.png"))
            candidates.append(os.path.join(base, f"{key}.jpg"))
            candidates.append(os.path.join(base, f"{key}.svg"))
        for p in candidates:
            if os.path.isfile(p):
                return p
        return None

    def generate_report(self, whoscored_id: int, fotmob_id: Optional[int] = None,
                       output_file: Optional[str] = None, use_cache: bool = True,
                       dpi: int = 150, figsize: Tuple[int, int] = (20, 22)) -> plt.Figure:
        """
        Generate complete match report.

        Args:
            whoscored_id: WhoScored match ID
            fotmob_id: FotMob match ID (optional)
            output_file: Path to save figure
            use_cache: Use cached data
            dpi: DPI for output
            figsize: Figure size

        Returns:
            Matplotlib Figure
        """
        print("\n" + "=" * 70)
        print("MATCH REPORT GENERATION")
        print("=" * 70)

        # Load data
        print("\n1. Loading data...")
        whoscored_data, fotmob_data = self.data_loader.load_all_data(
            whoscored_id, fotmob_id, use_cache
        )

        # Process data
        print("2. Processing data...")
        processor = MatchProcessor(whoscored_data, fotmob_data)
        match_summary = processor.get_complete_match_summary()

        if not match_summary.get('success'):
            raise ValueError("Failed to process match data")

        # Extract team info
        home_id = match_summary['teams']['home']['id']
        away_id = match_summary['teams']['away']['id']
        home_name = match_summary['teams']['home']['name']
        away_name = match_summary['teams']['away']['name']
        home_color = match_summary['team_colors'].get('home_color', '#FF0000')
        away_color = match_summary['team_colors'].get('away_color', '#0000FF')

        print(f"\nMatch: {home_name} vs {away_name}")

        # Attach team logos if available
