"""
PostMatchReport - Streamlit Web Application
Interactive web app for generating and viewing match reports.
"""

import streamlit as st
import matplotlib.pyplot as plt
from io import BytesIO
import base64
from datetime import datetime
import json
import os

from Reporting.report_generator import ReportGenerator
from ETL.transformers.match_processor import MatchProcessor


# Page configuration
st.set_page_config(
    page_title="PostMatchReport",
    page_icon="‚öΩ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
    <style>
    .main {
        background-color: #f0f0f0;
    }
    .stButton>button {
        width: 100%;
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
    }
    .stButton>button:hover {
        background-color: #45a049;
    }
    h1 {
        color: #2c3e50;
        text-align: center;
    }
    h2 {
        color: #34495e;
    }
    .match-info {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    </style>
    """, unsafe_allow_html=True)


@st.cache_data(ttl=3600)
def generate_report_cached(whoscored_id: int, fotmob_id: int = None, *, theme: str = 'dark'):
    """
    Generate report with caching.

    Args:
        whoscored_id: WhoScored match ID
        fotmob_id: FotMob match ID

    Returns:
        Matplotlib Figure and match summary
    """
    # Use new ReportGenerator
    generator = ReportGenerator(cache_dir="./cache", theme=theme)

    # Generate complete report
    fig = generator.generate_report(
        whoscored_id=whoscored_id,
        fotmob_id=fotmob_id,
        output_file=None,
        use_cache=True,
        dpi=100
    )

    # Load data for summary info
    whoscored_data, fotmob_data = generator.data_loader.load_all_data(
        whoscored_id, fotmob_id, use_cache=True
    )

    # Process data for summary
    processor = MatchProcessor(whoscored_data, fotmob_data)
    match_summary = processor.get_complete_match_summary()

    return fig, match_summary


def fig_to_base64(fig, dpi=100):
    """
    Convert matplotlib figure to base64 string.

    Args:
        fig: Matplotlib figure
        dpi: DPI for image

    Returns:
        Base64 encoded string
    """
    buf = BytesIO()
    fig.savefig(buf, format='png', dpi=dpi, bbox_inches='tight', facecolor='#f0f0f0')
    buf.seek(0)
    img_str = base64.b64encode(buf.read()).decode()
    buf.close()
    return img_str


def main():
    """Main application."""

    # Sidebar
    with st.sidebar:
        st.image("https://img.icons8.com/color/96/000000/soccer-ball.png", width=80)
        st.title("‚öΩ PostMatchReport")
        st.markdown("---")

        st.header("Match Selection")

        # Manual ID input
        st.subheader("Enter Match IDs")

        whoscored_id = st.number_input(
            "WhoScored Match ID",
            min_value=1,
            value=1821302,
            help="Enter the WhoScored match ID from the URL (Default: Liverpool vs Man Utd, Jan 5 2025)"
        )

        fotmob_id = st.number_input(
            "FotMob Match ID (Optional)",
            min_value=0,
            value=3900958,
            help="Enter the FotMob match ID for enhanced stats (xG, colors, etc.)"
        )

        st.markdown("---")

        # Options
        st.subheader("Options")
        dpi_setting = st.select_slider(
            "Report Quality",
            options=[80, 100, 150, 200, 300],
            value=100,
            help="Higher DPI = better quality but slower generation"
        )

        use_cache = st.checkbox(
            "Use Cached Data",
            value=True,
            help="Load previously extracted data if available"
        )

        st.markdown("---")

        # Generate button
        generate_button = st.button("üîÑ Generate Report", type="primary")

        st.markdown("---")

        # Help section
        with st.expander("‚ÑπÔ∏è How to find Match IDs"):
            st.markdown("""
            **WhoScored:**
            1. Go to [WhoScored.com](https://www.whoscored.com)
            2. Navigate to a match page
            3. Look at the URL: `whoscored.com/Matches/{ID}/...`
            4. Copy the ID number

            **FotMob:**
            1. Go to [FotMob.com](https://www.fotmob.com)
            2. Navigate to a match page
            3. Look at the URL: `fotmob.com/matches/{ID}/...`
            4. Copy the ID number
            """)

        with st.expander("üìä What's in the report?"):
            st.markdown("""
            The report includes 12 visualizations:
            1. Match Summary Statistics
            2. Shot Map
            3. Match Momentum Graph
            4. Pass Networks (both teams)
            5. Key Passes & Assists
            6. Zone 14 & Half-Spaces (both teams)
            7. Penalty Box Entries
            8. Defensive Actions Heatmaps (both teams)
            9. Pitch Control Map
            """)

    # Main content
    st.title("üèüÔ∏è Football Match Report Generator")

    # Introduction
    if not generate_button:
        st.markdown("""
        <div class="match-info">
        <h3>Welcome to PostMatchReport!</h3>
        <p>Generate comprehensive football match reports with advanced visualizations.</p>
        <p><strong>Features:</strong></p>
        <ul>
            <li>12 detailed visualizations per match</li>
            <li>Pass networks and player positioning</li>
            <li>Shot maps with xG data</li>
            <li>Defensive actions and territorial control</li>
            <li>Match momentum analysis</li>
        </ul>
        <p>Enter match IDs in the sidebar and click "Generate Report" to begin.</p>
        </div>
        """, unsafe_allow_html=True)

        # Example section
        st.subheader("üì∏ Example Reports")
        col1, col2, col3 = st.columns(3)

